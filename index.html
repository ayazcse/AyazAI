<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AyazAI: Local Chat Interface</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Inter font and chat aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            transition: background-color 0.4s;
        }
        .container {
            max-width: 1000px;
        }
        /* Adjusted height for better mobile viewing */
        .chat-container {
            height: 70vh;
            max-height: 700px; 
        }
        /* Shared Bubble Styling */
        .user-bubble, .model-bubble {
            padding: 0.75rem 1.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            word-wrap: break-word; /* Ensure text wraps */
            overflow-wrap: break-word;
            max-width: 90%; /* Max width for bubbles */
        }

        /* Light Mode Bubbles - Sharp and Clean */
        .light .user-bubble {
            background-color: #7c3aed; /* Violet-600 */
            color: white;
            border-radius: 1rem 1rem 0.25rem 1rem;
            margin-left: auto;
        }
        .light .model-bubble {
            background-color: #f3f4f6; /* Gray-100 */
            color: #1f2937; /* Gray-800 */
            border-radius: 1rem 1rem 1rem 0.25rem;
            margin-right: auto;
        }
        
        /* Dark Mode Bubbles - High Contrast & Neon */
        .dark .user-bubble {
            background-color: #22d3ee; /* Cyan-400 */
            color: #111827; /* Dark text for contrast */
            border-radius: 1rem 1rem 0.25rem 1rem;
            margin-left: auto;
            /* Neon effect on background for a future vibe */
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.5); 
        }
        .dark .model-bubble {
            background-color: #1f2937; /* Gray-800 */
            color: #d1d5db; /* Gray-300 */
            border-radius: 1rem 1rem 1rem 0.25rem;
            margin-right: auto;
            /* Subtle glow */
            box-shadow: 0 0 5px rgba(126, 34, 206, 0.3);
        }

        /* Loader with a neon touch */
        .loader {
            border-top-color: #a78bfa; /* Violet-400 */
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<!-- Applying deep space background and gradient text colors -->
<body class="p-4 md:p-8 flex items-center justify-center bg-gray-950 dark:bg-black transition-colors">

    <div class="container mx-auto">
        <header class="text-center mb-6 flex justify-between items-center">
            <!-- Action Group: Theme & New Chat -->
            <div class="flex space-x-2">
                <!-- Theme Toggle -->
                <button id="theme-toggle" class="p-3 rounded-full bg-gray-800 dark:bg-gray-700 text-gray-200 dark:text-cyan-400 transition-colors shadow-xl hover:shadow-cyan-500/50" onclick="toggleTheme()">
                    <!-- Sun Icon (Light Mode) -->
                    <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <!-- Moon Icon (Dark Mode) -->
                    <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                
                <!-- New Chat Button (Clear History) -->
                <button id="new-chat-btn" 
                        class="p-3 rounded-full bg-red-600 dark:bg-red-700 text-white transition-colors shadow-xl hover:shadow-red-500/50 hover:bg-red-700" 
                        onclick="clearHistory()">
                    <!-- Trash/New Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.74 9l-.387 7.054a2 2 0 01-1.995 2.5l-2.673-.535a2 2 0 01-1.995-2.5L9.26 9m1.06 4.676l-1.06-1.06M12 6h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5v-1a1 1 0 011-1h4a1 1 0 011 1v1M5 7h14a1 1 0 011 1v12a2 2 0 01-2 2H6a2 2 0 01-2-2V8a1 1 0 011-1z"></path></svg>
                </button>
            </div>
            
            <!-- Gradient Title - The 'AyazAI' Vibe -->
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-violet-600 tracking-wider">AyazAI</h1>
            
            <!-- Removed UID span -->
            <span id="system-status" class="text-sm text-gray-500 dark:text-gray-400 p-2 border border-gray-700 rounded-lg">Status: Ready</span>

        </header>

        <!-- Main Chat Box: Floating Panel Effect -->
        <div class="bg-white dark:bg-gray-900 p-4 md:p-6 rounded-2xl shadow-2xl dark:shadow-violet-500/20 flex flex-col transition-colors border border-gray-200 dark:border-gray-800">
            <!-- Chat History Display -->
            <div id="chat-history" class="chat-container overflow-y-auto mb-4 p-4 md:p-6 border border-gray-300 dark:border-gray-700 rounded-xl flex flex-col space-y-4 bg-gray-50 dark:bg-gray-950">
                <!-- Initial Welcome Message -->
                <div id="initial-message-box" class="model-bubble p-3 shadow-md">
                    <span id="initial-message">Hello! I'm AyazAI, a local conversational engine. How can I assist you today?</span>
                </div>
                
                <!-- Loading Indicator -->
                <div id="loading-indicator" class="hidden my-4 self-center">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mx-auto"></div>
                </div>
            </div>

            <!-- Chat Input Section -->
            <div class="flex space-x-3">
                
                <!-- Location Button -->
                <button id="location-btn" 
                        class="px-3 bg-gray-500 text-white font-semibold rounded-xl focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all shadow-md flex items-center justify-center hover:bg-gray-600"
                        onclick="getLocation()">
                    <!-- Map Pin Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                
                <!-- Image Upload Button -->
                <button id="image-upload-btn" 
                        class="px-3 bg-violet-600 text-white font-semibold rounded-xl focus:outline-none focus:ring-4 focus:ring-violet-500 transition-all shadow-md flex items-center justify-center hover:bg-violet-700"
                        onclick="document.getElementById('image-input').click()">
                    <!-- Camera Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.414 5h3.172a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                
                <!-- Hidden File Input -->
                <input type="file" id="image-input" accept="image/*" class="hidden" onchange="previewImage(event)">


                <input type="text" id="user-input" placeholder="Initiate conversation..."
                       class="flex-grow p-4 border-2 border-violet-400 dark:border-cyan-500 rounded-xl focus:ring-violet-500 focus:border-violet-500 dark:bg-gray-800 dark:text-gray-100 transition-colors placeholder-gray-500 dark:placeholder-gray-400"
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                
                <!-- Send Button: Neon Violet Accent -->
                <button id="send-btn" 
                        class="px-6 bg-violet-600 text-white font-semibold rounded-xl hover:bg-violet-700 focus:outline-none focus:ring-4 focus:ring-violet-500 focus:ring-opacity-70 transition-all shadow-lg dark:shadow-violet-500/50 flex items-center justify-center"
                        onclick="sendMessage()">
                    <svg id="button-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
            </div>
            
            <!-- Image Preview Area -->
            <div id="image-preview-area" class="mt-3 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg hidden">
                <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Image attached (will be sent with next message):</p>
                <img id="image-preview" class="max-h-40 rounded-lg object-contain mb-2" src="" alt="Image Preview">
                <button onclick="clearImage()" class="text-sm text-red-500 hover:text-red-600">Remove Image</button>
            </div>


            <!-- Custom Modal for Errors -->
            <div id="error-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 w-full max-w-sm transform transition-all shadow-2xl dark:shadow-red-600/50">
                    <h3 class="text-xl font-bold text-red-600 mb-3 dark:text-red-400">Error: System Alert</h3>
                    <p id="error-message" class="text-gray-700 mb-4 dark:text-gray-200">An unknown error occurred.</p>
                    <button class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700" onclick="document.getElementById('error-modal').classList.add('hidden')">Acknowledge</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- API Key Comment ---
        const apiKey = "AIzaSyDmzDzuEiSMd3ZR9YT_f1T2EPz24mgbw5g"; 

        // --- Global State ---
        let userLocation = null; // Stores {latitude: N, longitude: E}
        let uploadedImage = null; // Stores {data: base64, mimeType: string}
        let chatHistory = []; // Local memory for the session
        
        // --- DOM Elements ---
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const locationBtn = document.getElementById('location-btn'); 
        const chatHistoryDiv = document.getElementById('chat-history');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const systemStatusSpan = document.getElementById('system-status');
        const initialMessageBox = document.getElementById('initial-message-box');
        const initialMessageSpan = document.getElementById('initial-message');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewArea = document.getElementById('image-preview-area');

        // --- API Constants ---
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
        const SYSTEM_PROMPT = "You are a friendly, concise, and helpful conversational assistant. Maintain context and memory throughout the conversation. For any query requiring current or real-time information (like weather, news, or recent events), you must use your search tool. Your persona is a high-tech AI named AyazAI. Since this application runs locally without a database, your memory only lasts for this session.";

        // --- Theme Management ---

        /**
         * Applies the selected theme and saves it to localStorage.
         * @param {string} theme - 'light' or 'dark'.
         */
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        /**
         * Toggles the current theme.
         */
        window.toggleTheme = function() {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
        }
        
        // Load theme preference on startup
        const preferredTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(preferredTheme);
        
        // --- Utility Functions ---

        /**
         * Generic error handler to display a message in a custom modal.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
            systemStatusSpan.textContent = "Status: Error";
        }

        /**
         * Helper function for fetching with exponential backoff retry.
         */
        async function fetchWithRetry(url, options, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
        }
        
        /**
         * Renders a new message bubble in the chat history.
         * @param {string} text - The message content.
         * @param {string} role - The role ('user' or 'model').
         * @param {string | null} imageUrl - Optional image URL to display above the text.
         */
        function displayMessage(text, role, imageUrl = null) {
            // Hide initial welcome message box if we display a real message
            if (chatHistory.length > 0) {
                initialMessageBox.classList.add('hidden');
            }

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex flex-col p-3 shadow-md ${role}-bubble`;
            
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.className = 'max-h-40 rounded-lg object-contain mb-2 self-center';
                messageWrapper.appendChild(img);
            }

            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            messageWrapper.appendChild(textSpan);
            
            chatHistoryDiv.appendChild(messageWrapper);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Auto-scroll
        }
        
        /**
         * Saves a message to the local chatHistory array and triggers display.
         * @param {string} role - The role ('user' or 'model').
         * @param {string} text - The message content.
         * @param {object | null} image - Optional image object {data: base64, mimeType: string}.
         */
        async function saveMessage(role, text, image = null) {
            // 1. Prepare message parts for local history (context for API)
            const parts = [{ text }];
            if (image) {
                parts.unshift({ inlineData: { data: image.data, mimeType: image.mimeType } });
            }
            const message = { role, parts };
            
            // 2. Push to local memory
            chatHistory.push(message);

            // 3. Directly display the message
            const imageUrl = image ? `data:${image.mimeType};base64,${image.data}` : null;
            displayMessage(text, role, imageUrl);
        }

        /**
         * Clears all local chat history.
         */
        window.clearHistory = function() {
            if (!confirm('Are you sure you want to start a new chat? This will clear all messages in your local memory for this session.')) {
                return;
            }
            chatHistory = []; // Clear local array
            chatHistoryDiv.innerHTML = ''; // Clear display
            
            // Re-display initial welcome message
            initialMessageBox.classList.remove('hidden');
            chatHistoryDiv.appendChild(initialMessageBox);

            systemStatusSpan.textContent = "Status: New Chat";
            console.log("Chat history cleared locally.");
        }


        // --- Image Handling ---

        /**
         * Clears the image preview and the global state.
         */
        window.clearImage = function() {
            uploadedImage = null;
            imageInput.value = '';
            imagePreview.src = '';
            imagePreviewArea.classList.add('hidden');
            userInput.focus();
        }

        /**
         * Reads the uploaded file and updates the preview/global state.
         * @param {Event} event - The file input change event.
         */
        window.previewImage = function(event) {
            const file = event.target.files[0];
            if (!file) {
                clearImage();
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result.split(',')[1];
                const mimeType = file.type;
                
                // Set global state
                uploadedImage = {
                    data: base64String,
                    mimeType: mimeType
                };

                // Update preview
                imagePreview.src = e.target.result;
                imagePreviewArea.classList.remove('hidden');
                userInput.focus();
            };
            reader.readAsDataURL(file);
        }

        // --- Geolocation Functionality ---
        window.getLocation = function() {
            if (!navigator.geolocation) {
                displayError("Geolocation is not supported by your browser.");
                return;
            }

            systemStatusSpan.textContent = "Status: Requesting Location...";
            
            locationBtn.disabled = true;
            locationBtn.classList.add('opacity-50');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        latitude: position.coords.latitude.toFixed(4),
                        longitude: position.coords.longitude.toFixed(4)
                    };
                    systemStatusSpan.textContent = `Location: Lat ${userLocation.latitude}, Lon ${userLocation.longitude}`;
                    
                    locationBtn.disabled = false;
                    // Change to a neon-like cyan color on success
                    locationBtn.classList.remove('opacity-50', 'bg-gray-500', 'hover:bg-gray-600');
                    locationBtn.classList.add('bg-cyan-500', 'hover:bg-cyan-600', 'shadow-cyan-500/50');
                },
                (error) => {
                    locationBtn.disabled = false;
                    locationBtn.classList.remove('opacity-50', 'bg-cyan-500', 'hover:bg-cyan-600', 'shadow-cyan-500/50');
                    locationBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');

                    let errorMsg = "Could not retrieve location data.";
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMsg = "Access Denied.";
                    }
                    systemStatusSpan.textContent = `Status: Location Error (${errorMsg})`;
                    userLocation = null; 
                }
            );
        }

        // --- Main Send Message Function ---

        /**
         * Main function to send a message and get an AI response.
         */
        window.sendMessage = async function() {
            const userQuery = userInput.value.trim();
            if (!userQuery && !uploadedImage) return;

            // --- UI State: User Message & Loading ---
            userInput.value = ''; 
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-70', 'cursor-not-allowed');
            loadingIndicator.classList.remove('hidden');
            systemStatusSpan.textContent = "Status: Thinking...";

            // 1. Create the parts array for the API payload
            let parts = [];
            
            // Add image part if present
            if (uploadedImage) {
                parts.push({
                    inlineData: {
                        data: uploadedImage.data,
                        mimeType: uploadedImage.mimeType
                    }
                });
            }
            
            // Add text part (even if empty, for image-only queries)
            let promptWithLocation = userQuery || "Analyze the image.";
            if (userLocation) {
                // Prepend location context to the user's message for the model's benefit
                promptWithLocation = `(User Location: Lat ${userLocation.latitude}, Lon ${userLocation.longitude}) ${promptWithLocation}`;
            }
            parts.push({ text: promptWithLocation });


            // 2. Save the user's message to local memory/UI
            await saveMessage('user', userQuery || "Image attached.", uploadedImage);
            
            // Clear image immediately after saving for the session
            clearImage();

            // 3. Prepare chat history for API (context)
            // Add the new user message to the context for the AI call
            const contentsForApi = [...chatHistory];
            
            // Limit context to the last 10 turns (user + model messages) for speed
            const limitedContentsForApi = contentsForApi.slice(-10);

            const payload = {
                contents: limitedContentsForApi, 
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(API_URL, options);
                const result = await response.json();
                
                const modelResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!modelResponseText) {
                    throw new Error("Received an empty or malformed response from the model.");
                }
                
                // 4. Save the model response to local memory/UI
                await saveMessage('model', modelResponseText);

            } catch (error) {
                console.error("API Error:", error);
                displayError(`API connection error: ${error.message}. Please check console.`);
            } finally {
                loadingIndicator.classList.add('hidden');
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                userInput.focus();
                systemStatusSpan.textContent = "Status: Ready";
            }
        }
    </script>
</body>
</html>
