<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="7055cb5a-6da4-4656-8d47-4eace94c32cd.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI:az - The Respectful Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
       /* ========== GLOBAL VARIABLES ========== */
:root {
  --bg-light-start: #fef9e7;
  --bg-light-end: #fdf2e9;
  --bg-dark-start: #132a4e;
  --bg-dark-end: #0a1930;

  --text-light: #1a202c;
  --text-dark: #f3f4f6;

  --user-bg-light: #4caf50;
  --user-text-light: #ffffff;

  --model-bg-light: #ffe0b2;
  --model-text-light: #795548;

  --user-bg-dark: #81c784;
  --user-text-dark: #1a202c;

  --model-bg-dark: #3e2723;
  --model-text-dark: #ffcc80;
}

/* ========== BASE SETUP ========== */
html, body {
  padding: 0;
  margin: 0;
  height: 100dvh; /* mobile safe viewport */
  width: 100%;
  overflow: hidden;
  font-family: 'Inter', sans-serif;
  -webkit-tap-highlight-color: transparent;
}

/* Light Theme */
body {
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, var(--bg-light-start), var(--bg-light-end));
  color: var(--text-light);
}

/* Dark Theme */
.dark body {
  background: linear-gradient(135deg, var(--bg-dark-start), var(--bg-dark-end));
  color: var(--text-dark);
}

/* ========== APP CONTAINER ========== */
.app-container {
  display: flex;
  flex-direction: column;
  height: 100dvh;
  width: 100%;
  background: #ffffff;
  padding-bottom: env(safe-area-inset-bottom);
}

.dark .app-container {
  background: #1f2937;
}

/* ========== CHAT AREA ========== */
#chat-history {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  min-height: 0;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
}

/* ========== CHAT BUBBLES ========== */
.user-bubble, .model-bubble {
  max-width: 90%;
  padding: 0.9rem 1.15rem;
  margin: 0.45rem 0;
  border-radius: 1.4rem;
  word-break: break-word;
  white-space: pre-wrap;
  font-size: 0.97rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

/* Align */
.user-bubble-container {
  display: flex;
  justify-content: flex-end;
}

.model-bubble-container {
  display: flex;
  justify-content: flex-start;
}

/* Light Mode Bubbles */
.user-bubble {
  background: var(--user-bg-light);
  color: var(--user-text-light);
  border-radius: 1.4rem 1.4rem 0.4rem 1.4rem;
}

.model-bubble {
  background: var(--model-bg-light);
  color: var(--model-text-light);
  border-radius: 1.4rem 1.4rem 1.4rem 0.4rem;
}

/* Dark Mode Bubbles */
.dark .user-bubble {
  background: var(--user-bg-dark);
  color: var(--user-text-dark);
}

.dark .model-bubble {
  background: var(--model-bg-dark);
  color: var(--model-text-dark);
}

/* ========== IMAGE IN CHAT BUBBLE ========== */
.bubble-image {
  width: 100%;
  max-height: 12rem;
  object-fit: contain;
  border-radius: 0.6rem;
  margin-bottom: 0.4rem;
  background: #ffffff;
  padding: 4px;
}

/* ========== IMAGE PREVIEW GRID (BEFORE SEND) ========== */
.image-preview-wrapper {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(95px, 1fr));
  gap: 0.7rem;
  max-height: 150px;
  overflow-y: auto;
  margin-top: 0.5rem;
  -webkit-overflow-scrolling: touch;
}

.preview-item {
  position: relative;
  height: 90px;
  border-radius: 0.6rem;
  overflow: hidden;
  background: #e9ecef;
}

.preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.remove-image-btn-sm {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  font-size: 12px;
  font-weight: bold;
  background: rgba(255, 60, 60, 0.85);
  color: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ========== INPUT BAR ========== */
#user-input {
  width: 100%;
  border-radius: 50px;
  border: 2px solid #d1d5db;
  padding: 0.85rem 1.2rem;
  background: #f9fafb;
  font-size: 1rem;
}

.dark #user-input {
  background: #374151;
  border-color: #4b5563;
  color: #ffffff;
}

/* ========== AUDIO & ACTION BUTTONS ========== */
.audio-btn {
  background: none;
  border: none;
  padding: 0.35rem;
  cursor: pointer;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  transition: transform .18s;
}

.audio-btn:hover:not(:disabled) {
  transform: scale(1.12);
}

.audio-playing {
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.25); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}

/* ========== TYPING INDICATOR ========== */
.typing-indicator-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #ff9800;
  display: inline-block;
  margin: 0 2px;
  animation: bounce 1.3s infinite ease-in-out;
}

.dark .typing-indicator-dot {
  background: #ffb74d;
}

.typing-indicator-dot:nth-child(1) { animation-delay: -0.28s; }
.typing-indicator-dot:nth-child(2) { animation-delay: -0.14s; }

@keyframes bounce {
  0%,80%,100% { transform: scale(0); }
  40% { transform: scale(1); }
}

    </style>
</head>
<body class="p-0 m-0 transition-colors duration-300">
    

    <!-- Main App Container (Takes up the whole screen) -->
    <div class="app-container flex flex-col transition-colors duration-300 overflow-hidden">
        
        <!-- Header Section -->

        <header class="p-3 flex justify-between items-center border-b shadow-md flex-shrink-0 bg-white dark:bg-gray-900 dark:border-gray-700 transition-colors duration-300 flex-wrap">
            
            <!-- Group 1: Toggle, New Chat, Title -->
            <div class="flex items-center space-x-2 flex-grow min-w-0">
                
                <!-- Theme Toggle Button -->
                <button id="theme-toggle-btn" 
                        class="p-2 rounded-full text-orange-500 dark:text-yellow-400 bg-orange-100 dark:bg-gray-700 transition-colors hover:bg-orange-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-orange-300 dark:focus:ring-yellow-500 shadow-md w-10 h-10 flex items-center justify-center flex-shrink-0" 
                        onclick="toggleTheme()">
                    <svg id="theme-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </button>
                
                <!-- New Chat Button -->
                <button id="new-chat-btn" 
                        class="p-2 rounded-full bg-red-600 text-white transition-colors hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-400 shadow-md w-10 h-10 flex items-center justify-center flex-shrink-0" 
                        onclick="showConfirmClearHistory()">
                    <!-- Trash/New Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.74 9l-.387 7.054a2 2 0 01-1.995 2.5l-2.673-.535a2 2 0 01-1.995-2.5L9.26 9m1.06 4.676l-1.06-1.06M12 6h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5v-1a1 1 0 011-1h4a1 1 0 011 1v1M5 7h14a1 1 0 011 1v12a2 2 0 01-2 2H6a2 2 0 01-2-2V8a1 1 0 011-1z"></path></svg>
                </button>
                
                <!-- AI:az Title (Renamed and styled with Indian flag colors) -->
                <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-600 to-green-600 tracking-tight ml-2 truncate mr-auto">
                    AI:az
                </h1>
            </div>
            
            <!-- Group 2: Status Badge & Location (Consolidated) -->
            <div class="flex items-center space-x-2 text-right flex-shrink-0 mt-1 sm:mt-0"> 
                <span id="system-status" class="text-xs p-1 px-2 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg transition-colors duration-300 font-semibold">Status: Ready</span>
                <span id="location-status" class="text-xs p-1 px-2 rounded-lg transition-all border text-gray-500 dark:text-gray-400 border-gray-300 dark:border-gray-600 font-medium">
                    Loc: Off
                </span>
            </div>
        </header>

        <!-- Chat History Display -->
        <div id="chat-history" class="chat-history-bg flex flex-col space-y-4 bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
            <!-- Initial Welcome Message -->
            <div id="initial-message-box" class="model-bubble-container">
                <div class="model-bubble p-3 shadow-md flex items-end">
                    <span id="initial-message" class="flex-grow">Namaste. Main AI:az hoon, aapka sahayak. Ab main aapse aasaan Hindi mein baat karunga. Audio bhi ab Hindi accent mein shuru hoga. Aapki kya seva karoon, huzoor?</span>
                </div>
            </div>
            
            <!-- Typing Indicator (Replaced by just Loading) -->
            <div id="typing-indicator" class="hidden my-2 model-bubble-container">
                <div class="model-bubble text-sm text-gray-600 dark:text-gray-300 flex items-center p-3">
                    <span class="mr-3 font-semibold">AI:az is typing...</span>
                    <div class="flex">
                        <div class="typing-indicator-dot"></div>
                        <div class="typing-indicator-dot"></div>
                        <div class="typing-indicator-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Preview Area -->
        <div id="image-preview-area" class="p-3 flex-shrink-0 bg-gray-50 dark:bg-gray-900 border-t dark:border-gray-700 hidden">
            <p id="image-count-text" class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">Image Attached (Ekdum Sahi): 0 Images</p>
            <!-- Grid container for responsive image display -->
            <div id="uploaded-image-previews" class="image-preview-wrapper">
                <!-- Image previews will be dynamically inserted here -->
            </div>
        </div>


        <!-- Chat Input Section -->
        <div class="p-2 border-t flex space-x-2 flex-shrink-0 bg-white dark:bg-gray-900 dark:border-gray-700 transition-colors duration-300 shadow-inner">
            
            <!-- Location Button (Map Icon) -->
            <button id="location-btn" 
                    class="p-2 bg-orange-500 text-white rounded-full focus:outline-none focus:ring-4 focus:ring-orange-300 transition-all hover:bg-orange-600 shadow-lg flex items-center justify-center w-12 h-12 flex-shrink-0 hover:scale-105" 
                    onclick="getLocation()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243m.707-8.243a7 7 0 119.899 9.899L12 20.908l-5.303-5.303a7 7 0 019.899-9.899z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
            
            <!-- Image Upload Button (Now handles multiple selection) -->
            <button id="image-upload-btn" 
                    class="p-2 bg-green-500 text-white rounded-full focus:outline-none focus:ring-4 focus:ring-green-300 transition-all hover:bg-green-600 shadow-lg flex items-center justify-center w-12 h-12 flex-shrink-0 hover:scale-105"
                    onclick="document.getElementById('image-input').click()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 16m-1-4V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h12a2 2 0 002-2v-3"></path></svg>
            </button>
            
            <!-- Hidden File Input (Modified to allow multiple files) -->
            <input type="file" id="image-input" accept="image/*" class="hidden" multiple onchange="previewImages(event)">

            <input type="text" id="user-input" placeholder="Aapka sawaal kya hai, huzoor?"
                    class="flex-grow p-3 border rounded-full focus:ring-orange-500 focus:border-orange-500 transition-colors placeholder-gray-400 text-base dark:text-white"
                    onkeypress="if(event.key === 'Enter') sendMessage()">
            
            <!-- Send Button -->
            <button id="send-btn" 
                    class="p-2 bg-gradient-to-r from-orange-500 to-green-600 text-white rounded-full hover:from-orange-600 hover:to-green-700 focus:outline-none focus:ring-4 focus:ring-orange-300 transition-all shadow-xl w-12 h-12 flex items-center justify-center flex-shrink-0 hover:scale-105"
                    onclick="sendMessage()">
                <svg id="button-icon" class="w-6 h-6 rotate-90" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.25a.75.75 0 01.75.75v16.19l3.72-3.72a.75.75 0 111.06 1.06l-5 5a.75.75 0 01-1.06 0l-5-5a.75.75 0 111.06-1.06l3.72 3.72V3a.75.75 0 01.75-.75z"></path></svg>
            </button>
        </div>
        
        <!-- Custom Modal for Errors -->
        <div id="error-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-sm transform transition-all shadow-2xl">
                <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-3">System Error</h3>
                <p id="error-message" class="text-gray-700 dark:text-gray-300 mb-4">An unknown error occurred. Please try again.</p>
                <button class="w-full py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition" onclick="document.getElementById('error-modal').classList.add('hidden')">Theek Hai (Acknowledge)</button>
            </div>
        </div>
        
        <!-- Custom Modal for Confirmation (New Chat) -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-sm transform transition-all shadow-2xl">
                <h3 class="text-xl font-bold text-green-600 dark:text-green-400 mb-3">Confirm New Chat</h3>
                <p class="text-gray-700 dark:text-gray-300 mb-6">Are you sure you want to clear the history? All our chat will be permanently deleted. Kindly confirm.</p>
                <div class="flex justify-end space-x-3">
                    <button class="py-2 px-4 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 font-semibold rounded-xl hover:bg-gray-400 dark:hover:bg-gray-500 transition" onclick="document.getElementById('confirm-modal').classList.add('hidden')">Cancel</button>
                    <button class="py-2 px-4 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition" onclick="performClearHistory()">Clear History</button>
                </div>
            </div>
        </div>
        
        <!-- Location Permission Modal -->
        <div id="permission-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-sm transform transition-all shadow-2xl">
                <h3 class="text-xl font-bold text-orange-600 dark:text-orange-400 mb-3">Location Access Required</h3>
                <p id="permission-message" class="text-gray-700 dark:text-gray-300 mb-4">Location access was denied. We require this to provide location-aware results.</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">**To fix it:** Please go to your browser's settings for this page and change the Location permission to **"Allow"**. Then press the map button again.</p>
                <button class="w-full py-3 bg-orange-600 text-white font-semibold rounded-xl hover:bg-orange-700 transition" onclick="document.getElementById('permission-modal').classList.add('hidden')">Understood</button>
            </div>
        </div>

    </div>

    <script type="module">
        // --- API Key Comment ---
        const apiKey = "AIzaSyCy33W95OXXwcMzghPtuRrbnlwxOWry4Qw"; 

        // --- Global State ---
        let userLocation = null; 
        // Changed to array to hold multiple image objects
        let uploadedImages = []; 
        let chatHistory = []; 
        let currentAudio = null; // To track currently playing audio instance
        let currentAudioButton = null; // To track the button associated with currentAudio
        let typingInterval = null; // To track the typing animation interval
        
        // --- DOM Elements ---
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const locationStatusSpan = document.getElementById('location-status'); 
        const chatHistoryDiv = document.getElementById('chat-history');
        const typingIndicator = document.getElementById('typing-indicator'); 
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const confirmModal = document.getElementById('confirm-modal'); 
        const systemStatusSpan = document.getElementById('system-status');
        const initialMessageBox = document.getElementById('initial-message-box');
        const imageInput = document.getElementById('image-input');
        // const imagePreview = document.getElementById('image-preview'); // No longer needed
        const imagePreviewArea = document.getElementById('image-preview-area');
        const uploadedImagePreviewsDiv = document.getElementById('uploaded-image-previews');
        const imageCountText = document.getElementById('image-count-text');
        const permissionModal = document.getElementById('permission-modal'); 
        const htmlElement = document.documentElement;
        const themeIcon = document.getElementById('theme-icon');

        // --- API Constants ---
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
        const TTS_MODEL = 'gemini-2.5-flash-preview-tts';
        
        // UPDATED SYSTEM PROMPT: Ab sirf aasaan Hindi aur adab se baat karega (Writing in English letters)
        const SYSTEM_PROMPT = "Aap AI:az, ek bahut hi madadgaar, adabdaar aur professional assistant hain. Aap hamesha saral aur aasaan Hindi mein jawaab denge. Aapko hamesha adab se, jaise 'huzoor', 'aapki seva mein', 'jee', 'shukriya' jaise shabdon ka istemaal karna hai. Latest information ke liye search tool ka istemaal zaroor karein. Aapke jawab sirf plain text mein hone chahiye, koi bolding ya italics nahi.";

        
        // --- Theme Management ---

        function setTheme(theme) {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>`; // Moon icon
                localStorage.setItem('theme', 'dark');
            } else {
                htmlElement.classList.remove('dark');
                themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>`; // Sun icon
                localStorage.setItem('theme', 'light');
            }
        }

        window.toggleTheme = function() {
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        }

        function initializeTheme() {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                setTheme(storedTheme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                setTheme('dark');
            } else {
                setTheme('light');
            }
        }


        // --- Utility Functions ---

        function displayError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            stopAudioPlayback(); // Stop audio if error occurs
        }

        /**
         * Robust fetch utility with exponential backoff for API calls.
         */
        async function fetchWithRetry(url, options, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
        }
        
        function stripMarkdown(text) {
            // Remove code blocks, bolding, and italics.
            let cleanedText = text.replace(/```.*?```/gs, ''); 
            cleanedText = cleanedText.replace(/\*\*/g, ''); 
            cleanedText = cleanedText.replace(/\*/g, '');  
            cleanedText = cleanedText.replace(/_/g, '');  
            
            return cleanedText.trim();
        }

        /**
         * Creates and appends a new message bubble container.
         * Note: Initial text is set to empty string to prepare for typing effect.
         * imageUrls is an array of data URLs.
         */
        function createMessageBubble(role, text = '', imageUrls = []) {
            if (chatHistory.length > 0 && !initialMessageBox.classList.contains('hidden')) {
                initialMessageBox.classList.add('hidden');
            }
            
            const messageContainer = document.createElement('div');
            messageContainer.className = `${role}-bubble-container mb-4`;

            const messageWrapper = document.createElement('div');
            // Add flex layout to manage the text content and the audio button side-by-side
            messageWrapper.className = `${role}-bubble shadow-lg flex items-end`; 
            
            if (imageUrls.length > 0) {
                // Create a container for multiple images in the chat history bubble
                const imageGrid = document.createElement('div');
                imageGrid.className = 'w-full grid gap-2 mb-2 p-1' + 
                                       ' grid-cols-2 sm:grid-cols-3 md:grid-cols-4'; 
                
                imageUrls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'bubble-image w-full h-auto max-h-40'; // Adjusted class for history view
                    img.loading = 'lazy';
                    
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'rounded-lg overflow-hidden border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700';
                    imgWrapper.appendChild(img);
                    imageGrid.appendChild(imgWrapper);
                });
                
                messageWrapper.appendChild(imageGrid);
            }

            const textSpan = document.createElement('span');
            textSpan.textContent = text; // Initial text (empty for model reply)
            textSpan.className = 'flex-grow'; // Allows text to take up most space
            
            // Only add the text span if it has content or if it's the user's side of an image message
            if (text || role === 'user' || imageUrls.length === 0) {
                 messageWrapper.appendChild(textSpan);
            }
            
            // Add Audio Button only for Model replies
            let audioButton = null;
            if (role === 'model') {
                audioButton = document.createElement('button');
                audioButton.className = 'audio-btn w-6 h-6 flex-shrink-0';
                audioButton.title = 'Suniye (Listen)';
                audioButton.innerHTML = `<svg id="speaker-icon" class="w-full h-full" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 5L6 9H2v6h4l5 4V5zm7.5 7c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM16 5.86v12.28c2.19-.85 3.5-3.05 3.5-5.14s-1.31-4.29-3.5-5.14z"></path></svg>`;
                audioButton.onclick = () => handleAudioPlayback(audioButton);
                audioButton.disabled = true; // Disable until typing is complete
                messageWrapper.appendChild(audioButton);
                
                // Note: dataset.fullText is set in sendMessage for model replies
            }

            messageContainer.appendChild(messageWrapper);
            chatHistoryDiv.appendChild(messageContainer);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; 
            
            return {textSpan, audioButton};
        }

        /**
         * Simulates typing effect for the model's response.
         */
        function typeText(element, text, delay = 35, callback = null) {
            let i = 0;
            element.textContent = ''; 
            
            if (typingInterval) {
                clearInterval(typingInterval);
            }

            typingInterval = setInterval(() => {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    // Scroll chat history to keep up with the typing text
                    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
                    i++;
                } else {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    if (callback) {
                        callback();
                    }
                }
            }, delay);
        }
        
        // Modified to accept an array of image objects
        async function saveMessage(role, text, images = []) {
            const parts = [];
            
            // Add all image parts
            images.forEach(image => {
                parts.push({ inlineData: { data: image.data, mimeType: image.mimeType } });
            });
            
            const messageText = text || (role === 'user' && images.length > 0 ? "Multiple images attached." : (text || "Response"));
            parts.push({ text: messageText });

            const message = { role, parts };
            
            chatHistory.push(message);
        }

        window.showConfirmClearHistory = function() {
            stopAudioPlayback(); // Stop audio before showing modal
            confirmModal.classList.remove('hidden');
        }

        window.performClearHistory = function() {
            confirmModal.classList.add('hidden');
            
            stopAudioPlayback(); // Stop audio on clear
            if (typingInterval) clearInterval(typingInterval); // Stop typing

            chatHistory = []; 
            chatHistoryDiv.innerHTML = ''; 
            
            userLocation = null;
            updateLocationStatus('off');

            // Clear images
            clearImages();

            initialMessageBox.classList.remove('hidden');
            // Re-wrap initial message for correct alignment after clearing
            const initialMessageContainer = document.createElement('div');
            initialMessageContainer.className = 'model-bubble-container';
            initialMessageContainer.appendChild(initialMessageBox);
            chatHistoryDiv.appendChild(initialMessageContainer);

            // Re-add audio button to initial message if it was cleared
            const initialText = document.getElementById('initial-message').textContent;
            const existingButton = initialMessageBox.querySelector('.audio-btn');
            if (!existingButton) {
                const initialWrapper = initialMessageBox.querySelector('.model-bubble');
                addAudioButtonToInitialMessage(initialText, initialWrapper);
                // Ensure the initial message button is enabled after clear
                initialWrapper.querySelector('.audio-btn').disabled = false;
            }

            systemStatusSpan.textContent = "Status: New Chat";
            console.log("Chat history cleared locally.");
        }


        // --- Multiple Image Handling ---

        window.clearImages = function() {
            uploadedImages = [];
            imageInput.value = ''; // Clear file input
            uploadedImagePreviewsDiv.innerHTML = '';
            imagePreviewArea.classList.add('hidden');
            imageCountText.textContent = "Image Attached (Ekdum Sahi): 0 Images";
            userInput.focus();
        }
        
        window.removeImage = function(index) {
            uploadedImages.splice(index, 1);
            renderPreviews();
            userInput.focus();
        }
        
        function renderPreviews() {
            uploadedImagePreviewsDiv.innerHTML = '';
            
            if (uploadedImages.length === 0) {
                imagePreviewArea.classList.add('hidden');
                imageCountText.textContent = "Image Attached (Ekdum Sahi): 0 Images";
                return;
            }
            
            imagePreviewArea.classList.remove('hidden');
            imageCountText.textContent = `Image Attached (Ekdum Sahi): ${uploadedImages.length} Images`;

            uploadedImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                
                const img = document.createElement('img');
                img.src = image.dataUrl;
                img.alt = `Preview ${index + 1}`;
                img.loading = 'lazy';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-image-btn-sm';
                removeBtn.textContent = 'X';
                removeBtn.title = `Hatao Image ${index + 1}`;
                removeBtn.onclick = () => removeImage(index);
                
                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                uploadedImagePreviewsDiv.appendChild(previewItem);
            });
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; // Scroll to bottom to show preview area
        }
        
        window.previewImages = function(event) {
            const files = event.target.files;
            if (!files.length) {
                // If the user cancelled the selection, do nothing if images are already present
                if (uploadedImages.length === 0) {
                    clearImages();
                }
                return;
            }

            // Clear previous selections if starting a new upload round
            uploadedImages = []; 

            // Process all selected files
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    console.warn(`File ${file.name} is not an image and was skipped.`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result.split(',')[1];
                    const mimeType = file.type;
                    const dataUrl = e.target.result;
                    
                    uploadedImages.push({
                        data: base64String,
                        mimeType: mimeType,
                        dataUrl: dataUrl // Store Data URL for previewing
                    });
                    
                    // Re-render the previews every time a file loads
                    if (uploadedImages.length === files.length) {
                        renderPreviews();
                    }
                };
                reader.readAsDataURL(file);
            });
            
            // If the user selected files but some were invalid, ensure we render what's valid.
            // A short delay helps ensure all FileReader async operations complete if the list is small.
            setTimeout(renderPreviews, 100); 
        }


        // --- Geolocation Functionality ---

        function updateLocationStatus(state, message = '') {
            
            locationStatusSpan.className = 'text-xs p-1 px-2 rounded-lg transition-all border font-medium'; // Reset classes
            
            if (state === 'acquiring') {
                locationStatusSpan.textContent = 'Loc: Acquiring...';
                locationStatusSpan.classList.add('location-active', 'bg-orange-100', 'dark:bg-orange-700', 'text-orange-700', 'dark:text-orange-300', 'border-orange-400');
            } else if (state === 'acquired') {
                const lat = userLocation.lat.toFixed(4);
                const lon = userLocation.lon.toFixed(4);
                locationStatusSpan.textContent = `Loc: ${lat}, ${lon} (Acquired)`;
                locationStatusSpan.classList.add('bg-green-200', 'text-green-900', 'border-green-400', 'location-active');
            } else if (state === 'denied') {
                locationStatusSpan.textContent = `Loc: Denied`;
                locationStatusSpan.classList.add('bg-red-500', 'text-white', 'border-red-600');
                permissionModal.classList.remove('hidden');
            } else { // 'off' or error
                locationStatusSpan.textContent = `Loc: Off${message ? ` (${message})` : ''}`;
                locationStatusSpan.classList.add('text-gray-500', 'dark:text-gray-400', 'border-gray-300', 'dark:border-gray-600', 'bg-white', 'dark:bg-gray-800');
            }
        }


        window.getLocation = function() {
            if (navigator.geolocation) {
                updateLocationStatus('acquiring');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        updateLocationStatus('acquired');
                        console.log("Location acquired:", userLocation);
                    },
                    (error) => {
                        userLocation = null;
                        if (error.code === error.PERMISSION_DENIED) {
                            updateLocationStatus('denied');
                        } else {
                            updateLocationStatus('off', 'GPS Error');
                            console.error("Geolocation Error:", error.message);
                        }
                    },
                    // Low accuracy is fine for general location context
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 } 
                );
            } else {
                displayError("Geolocation is not supported by your browser, sir/ma'am.");
                updateLocationStatus('off', 'Unsupported');
            }
        }


        // --- Text-to-Speech (TTS) Implementation ---
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; 
            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);
            let offset = 0;

            // RIFF chunk
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + pcm16.length * bytesPerSample, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;
            
            // fmt chunk
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2; 
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, sampleRate * numChannels * bytesPerSample, true); offset += 4; 
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2; 
            view.setUint16(offset, bytesPerSample * 8, true); offset += 2; 
            
            // data chunk
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, pcm16.length * bytesPerSample, true); offset += 4;

            // Write PCM data
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        function stopAudioPlayback() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0; // Reset audio position
                
                if (currentAudioButton) {
                    currentAudioButton.disabled = false;
                    currentAudioButton.classList.remove('audio-playing');
                    currentAudioButton.innerHTML = `<svg id="speaker-icon" class="w-full h-full" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 5L6 9H2v6h4l5 4V5zm7.5 7c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM16 5.86v12.28c2.19-.85 3.5-3.05 3.5-5.14s-1.31-4.29-3.5-5.14z"></path></svg>`;
                }
                
                currentAudio = null;
                currentAudioButton = null;
            }
        }

        /**
         * Converts text to speech and plays the audio via a user interaction (button click) or automatically.
         */
        async function speakText(text, button, autoPlay = false) {
           const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;

            
            // If another audio is playing, stop it first
            stopAudioPlayback();
            
            // Set current state
            currentAudioButton = button;
            button.disabled = true;
            button.innerHTML = `<svg class="w-full h-full animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356-2H15a.5.5 0 00-.5.5V11m5.356 2h-4.721c-1.399 0-2.5-1.101-2.5-2.5v-1c0-1.399 1.101-2.5 2.5-2.5H19m-4 12v-5h.582m-15.356 2A8.001 8.001 0 0119.418 15m-15.356 2H9a.5.5 0 00.5-.5V13m-5.356 2h4.721c1.399 0 2.5 1.101 2.5 2.5v1c0 1.399-1.101 2.5-2.5 2.5H5"></path></svg>`;

           const payload = {
  contents: [{
    parts: [{
      text: `Aap ek professional, adabdaar Indian assistant hain. 
      Please iss text ko Indian accent aur Hindi uchchaaran mein bolen: ${text}`
    }]
  }],
  
  // ✅ Standard Google TTS config
  audioConfig: {
    voice: {
      name: "Orus" // Male Indian tone (closest)
    },
    speakingRate: 1.0,
    pitch: 0,
    volumeGainDb: 0,
    effectsProfileId: ["telephony-class-application"]
  }
};


            try {
                const response = await fetchWithRetry(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
             const audioData = result?.candidates?.[0]?.audio?.data;
const sampleRate = result?.candidates?.[0]?.audio?.sampleRateHz || 24000;


                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000; 

                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    currentAudio = audio; // Track this audio instance
                    
                    // Update button UI to stop/pause icon and pulsing
                    button.classList.add('audio-playing');
                    button.innerHTML = `<svg class="w-full h-full" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`; // Pause/Stop Icon

                    // Re-enable the button so user can stop it
                    button.disabled = false;
                    
                    audio.onended = () => {
                        stopAudioPlayback(); // Reset to speaker icon
                    };
                    audio.onerror = (e) => {
                        console.error("Audio playback error:", e);
                        displayError("Audio chalaane mein dikkat aayi (Issue occurred playing audio), huzoor. Maafi chahta hoon.");
                        stopAudioPlayback();
                    };
                    
                    audio.play().catch(e => {
                        console.error("Audio playback failed (usually due to user interaction requirement):", e);
                        // If autoplay fails, revert to ready state and keep the speaker button
                        button.disabled = false;
                        button.classList.remove('audio-playing');
                        button.innerHTML = `<svg id="speaker-icon" class="w-full h-full" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 5L6 9H2v6h4l5 4V5zm7.5 7c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM16 5.86v12.28c2.19-.85 3.5-3.05 3.5-5.14s-1.31-4.29-3.5-5.14z"></path></svg>`;
                        currentAudio = null;
                        currentAudioButton = null;
                    });

                } else {
                    displayError("TTS API se sahi audio data nahi aaya (Did not receive proper audio data from TTS API). Kripya dobara try karein, huzoor.");
                    stopAudioPlayback();
                }
            }//// catch (error) {
              //  console.error("TTS API Error during speech generation:", error);
              //  stopAudioPlayback();
            }
        }
        
        // This function is called by the button click
        window.handleAudioPlayback = function(button) {
            // Get the full text from the parent bubble's data attribute
            const text = button.closest('.model-bubble').dataset.fullText;
            
            if (currentAudio && currentAudioButton === button) {
                // If the same audio is playing, stop it (correction/stop functionality)
                stopAudioPlayback();
            } else {
                // Otherwise, start or restart the audio
                speakText(text, button, true);
            }
        }
        
        // Function to be called after the model's text is fully displayed (INSTANTLY now)
        function startAutoAudio(button) {
            // Find the full text (it should be set in the saveMessage step)
            const text = button.closest('.model-bubble').dataset.fullText;
            if (text) {
                // Enable the button now that the text is complete
                button.disabled = false;
                systemStatusSpan.textContent = "Status: Ready (Audio playing)";
                // Ensure text is stripped of any final markdown for clean TTS input
                const cleanText = stripMarkdown(text);
                speakText(cleanText, button, true);
            }
        }
        
        // Helper function to add the audio button (used for initial message)
        function addAudioButtonToInitialMessage(text, wrapper) {
            const audioButton = document.createElement('button');
            audioButton.className = 'audio-btn w-6 h-6 flex-shrink-0';
            audioButton.title = 'Suniye (Listen)';
            audioButton.innerHTML = `<svg id="speaker-icon" class="w-full h-full" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 5L6 9H2v6h4l5 4V5zm7.5 7c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM16 5.86v12.28c2.19-.85 3.5-3.05 3.5-5.14s-1.31-4.29-3.5-5.14z"></path></svg>`;
            audioButton.onclick = () => handleAudioPlayback(audioButton);
            wrapper.appendChild(audioButton);
            wrapper.dataset.fullText = text;
        }

        // --- Main Send Message Function ---

        window.sendMessage = async function() {
            const userQuery = userInput.value.trim();
            if (!userQuery && uploadedImages.length === 0) return;

            // --- CRITICAL: Stop any currently playing audio immediately ---
            stopAudioPlayback();
            if (typingInterval) clearInterval(typingInterval); // Stop any ongoing typing

            
            // --- UI State: User Message & Loading ---
            userInput.value = ''; 
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-70', 'cursor-not-allowed');
            typingIndicator.classList.remove('hidden'); 
            systemStatusSpan.textContent = "Status: Soch raha hoon (Thinking), please wait...";

            let promptText = userQuery;
            const hasImages = uploadedImages.length > 0;
            
            if (userLocation) {
                // Location information ko Hindi mein shamil karein
                promptText = `User Location: [${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}]. Yeh location user ne di hai. Sawal: ${userQuery}`;
            } else if (hasImages && !userQuery) {
                 promptText = "Multiple images attach ki gayi hain. Kripya inmein kya dikh raha hai, bataiye aur mera margdarshan (guidance) karein?";
            } else if (hasImages && userQuery) {
                 promptText = `Sawalon par dhyan dete hue, in images ko analyze karein. Sawal: ${userQuery}`;
            }

            const currentImagesForSave = uploadedImages.map(img => ({
                data: img.data,
                mimeType: img.mimeType
            }));
            const currentImagesDataUrls = uploadedImages.map(img => img.dataUrl);

            // 1. Save and display the user's message immediately
            const userDisplayText = userQuery || (hasImages ? `Multiple Images Attached (${uploadedImages.length})` : "Image attached.");
            createMessageBubble('user', userDisplayText, currentImagesDataUrls);
            
            await saveMessage('user', userQuery, currentImagesForSave);
            
            // Clear location and image state immediately after using them
            userLocation = null;
            updateLocationStatus('off');
            clearImages();

            // 2. Prepare chat history for API (context)
            const contentsForApi = [...chatHistory]; 
            // The last entry contains the current prompt and images, we ensure the text part is correctly set
            const lastContent = contentsForApi[contentsForApi.length - 1];
            const textPart = lastContent.parts.find(p => p.text !== undefined);
            if (textPart) {
                textPart.text = promptText; 
            }
            
            const limitedContentsForApi = contentsForApi.slice(-10); 

            const payload = {
                contents: limitedContentsForApi, 
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            let modelResponseText = null;

            try {
                // Get the model's response text
                const response = await fetchWithRetry(API_URL, options);
                const result = await response.json();
                
                modelResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!modelResponseText) {
                    throw new Error("Model ne koi jawab nahi diya (Model returned an empty reply). Maafi chahta hoon, huzoor.");
                }
                
                const cleanResponseText = stripMarkdown(modelResponseText);
                
                // Hide indicator, update status
                typingIndicator.classList.add('hidden'); 
                systemStatusSpan.textContent = "Status: Jawab likh raha hoon (Writing reply)...";

                // Create the model bubble but with EMPTY text, so typing can start
                const {textSpan, audioButton} = createMessageBubble('model', '');
                
                // Set the full text on the bubble wrapper immediately for the TTS function later
                const modelBubble = textSpan.closest('.model-bubble');
                modelBubble.dataset.fullText = cleanResponseText; 
                
                // 3. Save the final message to history
                // This happens before typing starts, as the text is finalized now
                await saveMessage('model', cleanResponseText);
                
                // 4. *** Start the Typing Animation (and chain the audio) ***
                
                // Define callback to start audio after typing is done
                const audioCallback = () => {
                    systemStatusSpan.textContent = "Status: Awaaz shuru (Audio starting)...";
                    startAutoAudio(audioButton);
                };

                // Start typing the response with 35ms delay
                typeText(textSpan, cleanResponseText, 35, audioCallback);


            } catch (error) {
                // Log and display error
                console.error("API Error:", error);
                const errorMsg = error.message.includes("API connection error") ? error.message : `API request failed: ${error.message}`;
                displayError(errorMsg); 
                
                // If failed before typing, update status
                typingIndicator.classList.add('hidden');
                systemStatusSpan.textContent = "Status: Error";
            } finally {
                // Clean up UI state regardless of success or failure
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                userInput.focus();
                
                // If typing is still active (which shouldn't happen here if API failed immediately), we clear it.
                // Final status update will happen after audio starts in success case.
            }
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            updateLocationStatus('off');
            
            // Re-wrap initial message for correct alignment
            const initialMessageContainer = document.createElement('div');
            initialMessageContainer.className = 'model-bubble-container';
            initialMessageContainer.appendChild(initialMessageBox);
            chatHistoryDiv.appendChild(initialMessageContainer);
            
            // Add audio button to initial message
            const initialText = document.getElementById('initial-message').textContent;
            const initialWrapper = initialMessageBox.querySelector('.model-bubble');
            
            addAudioButtonToInitialMessage(initialText, initialWrapper);
            
            // Ensure the initial message text span takes up necessary space
            document.getElementById('initial-message').classList.add('flex-grow');
            
            // Enable the initial message audio button
            const initialAudioButton = initialMessageBox.querySelector('.audio-btn');
            if (initialAudioButton) {
                initialAudioButton.disabled = false;
                // Immediately start audio for the initial message to comply with the "default" request
                startAutoAudio(initialAudioButton);
            }
        });
    </script>
</body>
</html>
