<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AyazAI: Local Chat Interface</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Inter font and chat aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s, color 0.4s;
        }

        /* --- DARK THEME STYLES (Default) --- */
        [data-theme="dark"] body {
            background-color: #0d1117; /* Very Dark Blue-Gray */
            color: #d1d5db;
        }
        [data-theme="dark"] .app-bg {
            background-color: #161b22;
            border-color: #30363d;
            box-shadow: 0 10px 15px -3px rgba(126, 34, 206, 0.2), 0 4px 6px -2px rgba(126, 34, 206, 0.1);
        }
        [data-theme="dark"] .chat-history-bg {
            background-color: #0d1117;
            border-color: #30363d;
        }
        [data-theme="dark"] #user-input {
            background-color: #161b22;
            color: #d1d5db;
            border-color: #4a5568;
        }
        [data-theme="dark"] .model-bubble {
            background-color: #1f2937; 
            color: #d1d5db;
            box-shadow: 0 0 5px rgba(126, 34, 206, 0.3);
        }
        [data-theme="dark"] .user-bubble-wrapper {
             /* Wrapper for right alignment */
            align-self: flex-end; 
        }
        [data-theme="dark"] .user-bubble {
            background-color: #22d3ee; /* Cyan-400 */
            color: #111827;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.5); 
        }
        [data-theme="dark"] .loader {
            border-top-color: #a78bfa; 
        }
        [data-theme="dark"] .location-active {
             /* Cyan glow in dark mode */
            animation: pulse-border-dark 1.5s infinite;
        }
        @keyframes pulse-border-dark {
            0% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 211, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); }
        }


        /* --- LIGHT THEME STYLES --- */
        [data-theme="light"] body {
            background-color: #f7fafc; /* Near-White */
            color: #1a202c;
        }
        [data-theme="light"] .app-bg {
            background-color: #ffffff;
            border-color: #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        [data-theme="light"] .chat-history-bg {
            background-color: #f7fafc;
            border-color: #e2e8f0;
        }
        [data-theme="light"] #user-input {
            background-color: #ffffff;
            color: #1a202c;
            border-color: #cbd5e0;
        }
        [data-theme="light"] .model-bubble {
            background-color: #e2e8f0; /* Light Gray */
            color: #1a202c;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        [data-theme="light"] .user-bubble-wrapper {
            /* Wrapper for right alignment */
            align-self: flex-end; 
        }
        [data-theme="light"] .user-bubble {
            background-color: #90cdf4; /* Light Blue */
            color: #1a202c;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }
        [data-theme="light"] .location-active {
            /* Blue glow in light mode */
            animation: pulse-border-light 1.5s infinite;
        }
        @keyframes pulse-border-light {
            0% { box-shadow: 0 0 0 0 rgba(144, 205, 244, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(144, 205, 244, 0); }
            100% { box-shadow: 0 0 0 0 rgba(144, 205, 244, 0); }
        }


        /* Global Styles (not theme specific) */
        .container {
            max-width: 1000px;
        }
        .user-bubble, .model-bubble {
            padding: 0.75rem 1.25rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 90%; 
            white-space: pre-wrap;
        }
        .user-bubble-container {
            /* Ensures user messages (including image) align right */
            align-self: flex-end;
        }
        .model-bubble-container {
            /* Ensures model messages (including image) align left (default) */
            align-self: flex-start;
        }
        .loader {
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<!-- Initial theme is set to dark (controlled by JS) -->
<body class="p-4 md:p-8 flex flex-col h-screen overflow-hidden transition-colors">

    <div class="container mx-auto w-full flex flex-col flex-grow h-full">
        <header class="mb-6 flex justify-between items-center flex-shrink-0">
            <!-- Action Group -->
            <div class="flex space-x-2">
                
                <!-- Theme Toggle Button -->
                <button id="theme-toggle-btn" 
                        class="p-3 rounded-full bg-gray-500 text-white transition-colors shadow-xl hover:bg-gray-600" 
                        onclick="toggleTheme()">
                    <!-- Sun/Moon Icon (Will be swapped by JS) -->
                    <svg id="theme-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 3a9 9 0 109 9c0-.46-.04-.91-.1-1.35a.25.25 0 00-.33-.27.25.25 0 00-.27.33A7.5 7.5 0 0112 19.5a7.5 7.5 0 117.5-7.5c0 .46-.04.91-.1 1.35a.25.25 0 00-.33.27.25.25 0 00-.27-.33A7.5 7.5 0 0112 4.5a7.5 7.5 0 017.5 7.5 7.5 7.5 0 01-7.5 7.5.75.75 0 00.75.75c3.55 0 6.78-1.55 9-4.04a.75.75 0 00-1.28-.82c-2.02 2.22-4.9 3.56-8.22 3.56a9 9 0 01-9-9 9 9 0 0115-6.75A9 9 0 0012 3z"></path>
                    </svg>
                </button>

                <!-- New Chat Button (Clear History) - Calls confirmation modal -->
                <button id="new-chat-btn" 
                        class="p-3 rounded-full bg-red-700 text-white transition-colors shadow-xl hover:shadow-red-500/50 hover:bg-red-800" 
                        onclick="showConfirmClearHistory()">
                    <!-- Trash/New Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.74 9l-.387 7.054a2 2 0 01-1.995 2.5l-2.673-.535a2 2 0 01-1.995-2.5L9.26 9m1.06 4.676l-1.06-1.06M12 6h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5v-1a1 1 0 011-1h4a1 1 0 011 1v1M5 7h14a1 1 0 011 1v12a2 2 0 01-2 2H6a2 2 0 01-2-2V8a1 1 0 011-1z"></path></svg>
                </button>
            </div>
            
            <!-- Gradient Title - Centered Text -->
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-violet-600 tracking-wider text-center">AyazAI</h1>
            
            <!-- Status Badge: Adjusted text color for dark mode -->
            <span id="system-status" class="text-xs p-2 border rounded-lg hidden md:block flex-shrink-0">Status: Ready</span>

        </header>
        
        <!-- Location Status Indicator -->
        <div id="location-status-bar" class="flex justify-end mb-3 flex-shrink-0">
            <!-- Dynamic styling handled by JS -->
            <span id="location-status" class="text-xs p-2 rounded-lg transition-all border">
                Location: Off
            </span>
        </div>

        <!-- Main Chat Box: App-bg class handles theme background -->
        <div class="app-bg p-4 md:p-6 rounded-2xl shadow-2xl flex flex-col transition-colors border flex-grow overflow-hidden">
            <!-- Chat History Display. chat-history-bg class handles theme background -->
            <div id="chat-history" class="flex-grow overflow-y-auto mb-4 p-4 md:p-6 border rounded-xl flex flex-col space-y-4 chat-history-bg">
                <!-- Initial Welcome Message -->
                <div id="initial-message-box" class="model-bubble p-3 shadow-md model-bubble-container">
                    <span id="initial-message">Hello! I'm AyazAI, a local conversational engine. I can now speak my responses! How can I assist you today?</span>
                </div>
                
                <!-- Loading Indicator -->
                <div id="loading-indicator" class="hidden my-4 self-center">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mx-auto"></div>
                </div>
            </div>

            <!-- Chat Input Section. Added flex-shrink-0 -->
            <div class="flex space-x-2 flex-shrink-0">
                
                <!-- Location Button (Map Icon) -->
                <button id="location-btn" 
                        class="p-2 bg-cyan-600 text-white font-semibold rounded-xl focus:outline-none focus:ring-4 focus:ring-cyan-500 transition-all shadow-md flex items-center justify-center hover:bg-cyan-700" 
                        onclick="getLocation()">
                    <!-- Map/Location Pin Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243m.707-8.243a7 7 0 119.899 9.899L12 20.908l-5.303-5.303a7 7 0 019.899-9.899z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                
                <!-- Image Upload Button (Reduced padding from px-3 to p-2 for space) -->
                <button id="image-upload-btn" 
                        class="p-2 bg-violet-600 text-white font-semibold rounded-xl focus:outline-none focus:ring-4 focus:ring-violet-500 transition-all shadow-md flex items-center justify-center hover:bg-violet-700"
                        onclick="document.getElementById('image-input').click()">
                    <!-- Camera Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.414 5h3.172a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                
                <!-- Hidden File Input -->
                <input type="file" id="image-input" accept="image/*" class="hidden" onchange="previewImage(event)">


                <input type="text" id="user-input" placeholder="Initiate conversation..."
                        class="flex-grow p-4 border-2 rounded-xl focus:ring-violet-500 focus:border-violet-500 transition-colors placeholder-gray-400 min-w-0"
                        onkeypress="if(event.key === 'Enter') sendMessage()">
                
                <!-- Send Button: Reduced horizontal padding from px-6 to px-4 for space -->
                <button id="send-btn" 
                        class="px-4 bg-violet-600 text-white font-semibold rounded-xl hover:bg-violet-700 focus:outline-none focus:ring-4 focus:ring-violet-500 focus:ring-opacity-70 transition-all shadow-lg shadow-violet-500/50 flex items-center justify-center"
                        onclick="sendMessage()">
                    <svg id="button-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
            </div>
            
            <!-- Image Preview Area. Added flex-shrink-0 -->
            <div id="image-preview-area" class="mt-3 p-3 flex-shrink-0 bg-gray-800 rounded-lg hidden">
                <p class="text-sm font-semibold text-gray-300 mb-2">Image attached (will be sent with next message):</p>
                <img id="image-preview" class="max-h-40 rounded-lg object-contain mb-2" src="" alt="Image Preview">
                <button onclick="clearImage()" class="text-sm text-red-500 hover:text-red-600" id="remove-image-btn">Remove Image</button>
            </div>


            <!-- Custom Modal for Errors: Adjusted colors -->
            <div id="error-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
                <div class="bg-gray-700 rounded-xl p-6 w-full max-w-sm transform transition-all shadow-2xl shadow-red-600/50">
                    <h3 class="text-xl font-bold text-red-400 mb-3">Error: System Alert</h3>
                    <p id="error-message" class="text-gray-200 mb-4">An unknown error occurred.</p>
                    <button class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700" onclick="document.getElementById('error-modal').classList.add('hidden')">Acknowledge</button>
                </div>
            </div>
            
            <!-- Custom Modal for Confirmation (New Chat): Adjusted colors -->
            <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
                <div class="bg-gray-700 rounded-xl p-6 w-full max-w-sm transform transition-all shadow-2xl shadow-violet-600/50">
                    <h3 class="text-xl font-bold text-violet-400 mb-3">Confirm New Chat</h3>
                    <p class="text-gray-200 mb-6">Are you sure you want to start a new chat? This will clear all messages in your local memory for this session.</p>
                    <div class="flex justify-end space-x-3">
                        <button class="py-2 px-4 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600" onclick="document.getElementById('confirm-modal').classList.add('hidden')">Cancel</button>
                        <button class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700" onclick="performClearHistory()">Clear History</button>
                    </div>
                </div>
            </div>
            
            <!-- Location Permission Modal -->
            <div id="permission-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
                <div class="bg-gray-700 rounded-xl p-6 w-full max-w-sm transform transition-all shadow-2xl shadow-cyan-600/50">
                    <h3 class="text-xl font-bold text-cyan-400 mb-3">Location Permission Needed</h3>
                    <p id="permission-message" class="text-gray-200 mb-4">It looks like location access was denied by your browser.</p>
                    <p class="text-sm text-gray-300 mb-6">**To fix this:** You must go into your browser's site settings for this page and manually change the Location permission from **"Block"** to **"Allow"**, then try clicking the map button again.</p>
                    <button class="w-full py-3 bg-cyan-600 text-white font-semibold rounded-lg hover:bg-cyan-700" onclick="document.getElementById('permission-modal').classList.add('hidden')">Got it</button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        // --- API Key Comment ---
        const apiKey = "AIzaSyDmzDzuEiSMd3ZR9YT_f1T2EPz24mgbw5g"; 

        // --- Global State ---
        let userLocation = null; // Stores {lat: number, lon: number} if successfully fetched
        let uploadedImage = null; // Stores {data: base64, mimeType: string}
        let chatHistory = []; // Local memory for the session
        
        // --- DOM Elements ---
        const body = document.body;
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const locationBtn = document.getElementById('location-btn'); 
        const locationStatusSpan = document.getElementById('location-status'); 
        const chatHistoryDiv = document.getElementById('chat-history');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const confirmModal = document.getElementById('confirm-modal'); 
        const systemStatusSpan = document.getElementById('system-status');
        const initialMessageBox = document.getElementById('initial-message-box');
        const initialMessageSpan = document.getElementById('initial-message');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewArea = document.getElementById('image-preview-area');
        const themeIcon = document.getElementById('theme-icon');
        const permissionModal = document.getElementById('permission-modal'); 

        // --- API Constants ---
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
        const TTS_MODEL = 'gemini-2.5-flash-preview-tts';
        const SYSTEM_PROMPT = "You are a friendly, concise, and helpful conversational assistant. Maintain context and memory throughout the conversation. For any query requiring current or real-time information (like weather, news, or recent events), you must use your search tool. Your persona is a high-tech AI named AyazAI. Since this application runs locally without a database, your memory only lasts for this session. Your responses must be in plain text and should not use markdown formatting like **bolding** or *italics* as the client UI handles formatting. IMPORTANT: The user may include location data in their message: 'User Location: [LAT, LON]'. Use this if relevant for time, weather, or local recommendations.";

        
        // --- Utility Functions ---

        /**
         * Generic error handler to display a message in a custom modal.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
            systemStatusSpan.textContent = "Status: Error";
            sendBtn.disabled = false;
            sendBtn.classList.remove('opacity-70', 'cursor-not-allowed');
        }

        /**
         * Helper function for fetching with exponential backoff retry.
         */
        async function fetchWithRetry(url, options, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
        }
        
        /**
         * Removes markdown formatting (like **bold** or *italics*) from text.
         * @param {string} text - The input text.
         * @returns {string} The text with markdown symbols stripped.
         */
        function stripMarkdown(text) {
            let cleanedText = text.replace(/```.*?```/gs, ''); 
            cleanedText = cleanedText.replace(/\*\*/g, ''); 
            cleanedText = cleanedText.replace(/\*/g, '');  
            cleanedText = cleanedText.replace(/_/g, '');  
            
            return cleanedText.trim();
        }

        /**
         * Renders a new message bubble in the chat history.
         */
        function displayMessage(text, role, imageUrl = null) {
            if (chatHistory.length > 0 && !initialMessageBox.classList.contains('hidden')) {
                initialMessageBox.classList.add('hidden');
            }
            
            // Create a container to handle alignment (user=right, model=left)
            const messageContainer = document.createElement('div');
            messageContainer.className = role === 'user' ? 'user-bubble-container' : 'model-bubble-container';


            const messageWrapper = document.createElement('div');
            messageWrapper.className = `${role}-bubble`;
            // Ensure both user and model bubbles have rounded corners and left-aligned text for readability
            messageWrapper.classList.add('rounded-xl', 'text-left'); 
            
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.className = 'max-h-40 rounded-lg object-contain mb-2';
                messageWrapper.appendChild(img);
            }

            const textSpan = document.createElement('span');
            textSpan.textContent = text; 
            messageWrapper.appendChild(textSpan);
            
            messageContainer.appendChild(messageWrapper);
            chatHistoryDiv.appendChild(messageContainer);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight; 
        }
        
        /**
         * Saves a message to the local chatHistory array and triggers display.
         */
        async function saveMessage(role, text, image = null) {
            const parts = [{ text }];
            if (image) {
                parts.unshift({ inlineData: { data: image.data, mimeType: image.mimeType } });
            }
            const message = { role, parts };
            
            chatHistory.push(message);

            const imageUrl = image ? `data:${image.mimeType};base64,${image.data}` : null;
            displayMessage(text, role, imageUrl);
        }

        /**
         * Shows the custom modal to confirm clearing chat history.
         */
        window.showConfirmClearHistory = function() {
            confirmModal.classList.remove('hidden');
        }

        /**
         * Clears all local chat history after confirmation.
         */
        window.performClearHistory = function() {
            confirmModal.classList.add('hidden');
            
            chatHistory = []; 
            chatHistoryDiv.innerHTML = ''; 
            
            // Reset location state
            userLocation = null;
            updateLocationStatus('off');

            // Re-display initial welcome message
            initialMessageBox.classList.remove('hidden');
            // Re-add the initial message box wrapper to the chat history 
            const initialMessageContainer = document.createElement('div');
            initialMessageContainer.className = 'model-bubble-container';
            initialMessageContainer.appendChild(initialMessageBox);
            chatHistoryDiv.appendChild(initialMessageContainer);

            systemStatusSpan.textContent = "Status: New Chat";
            console.log("Chat history cleared locally.");
        }


        // --- Theme Toggle ---

        const SUN_ICON = '<path d="M12 3v1.5m-4.5 7.5a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zm4.5 4.5v1.5m4.5-12.6l-1.06 1.06m-6.36 10.6l-1.06 1.06m-6.36-4.24H3m1.5 0h1.5m6.36-8.48l1.06 1.06m-10.6 6.36l1.06 1.06"></path>';
        const MOON_ICON = '<path d="M12 3a9 9 0 109 9c0-.46-.04-.91-.1-1.35a.25.25 0 00-.33-.27.25.25 0 00-.27.33A7.5 7.5 0 0112 19.5a7.5 7.5 0 117.5-7.5c0 .46-.04.91-.1 1.35a.25.25 0 00-.33.27.25.25 0 00-.27-.33A7.5 7.5 0 0112 4.5a7.5 7.5 0 017.5 7.5 7.5 7.5 0 01-7.5 7.5.75.75 0 00.75.75c3.55 0 6.78-1.55 9-4.04a.75.75 0 00-1.28-.82c-2.02 2.22-4.9 3.56-8.22 3.56a9 9 0 01-9-9 9 9 0 0115-6.75A9 9 0 0012 3z"></path>';


        window.toggleTheme = function() {
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            updateThemeIcon(newTheme);
            updateSystemStatusStyle(newTheme);
        }

        function updateThemeIcon(theme) {
            themeIcon.innerHTML = theme === 'dark' ? MOON_ICON : SUN_ICON;
            themeIcon.setAttribute('fill', theme === 'dark' ? 'currentColor' : 'none');
            themeIcon.setAttribute('stroke', theme === 'dark' ? 'none' : 'currentColor');
            themeIcon.setAttribute('stroke-linecap', 'round');
            themeIcon.setAttribute('stroke-linejoin', 'round');
            themeIcon.setAttribute('stroke-width', '2');
        }
        
        function updateSystemStatusStyle(theme) {
            const isDark = theme === 'dark';
            // General status bar styling
            systemStatusSpan.classList.toggle('text-gray-400', isDark);
            systemStatusSpan.classList.toggle('border-gray-700', isDark);
            systemStatusSpan.classList.toggle('text-gray-700', !isDark);
            systemStatusSpan.classList.toggle('border-gray-300', !isDark);
        }


        // --- Image Handling ---

        window.clearImage = function() {
            uploadedImage = null;
            imageInput.value = '';
            imagePreview.src = '';
            imagePreviewArea.classList.add('hidden');
            userInput.focus();
        }

        window.previewImage = function(event) {
            const file = event.target.files[0];
            if (!file) {
                clearImage();
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result.split(',')[1];
                const mimeType = file.type;
                
                uploadedImage = {
                    data: base64String,
                    mimeType: mimeType
                };

                imagePreview.src = e.target.result;
                imagePreviewArea.classList.remove('hidden');
                userInput.focus();
            };
            reader.readAsDataURL(file);
        }

        // --- Geolocation Functionality ---

        function updateLocationStatus(state, message = '') {
            const isDark = body.getAttribute('data-theme') === 'dark';
            
            // Clear all state classes
            locationStatusSpan.classList.remove('location-active', 'bg-cyan-900', 'text-cyan-200', 'bg-red-800', 'text-white', 'bg-gray-100', 'text-gray-700', 'bg-blue-200', 'text-blue-900', 'text-gray-400', 'border-gray-700', 'border-gray-300');
            
            if (state === 'acquiring') {
                locationStatusSpan.textContent = 'Location: Acquiring...';
                locationStatusSpan.classList.add('location-active');
            } else if (state === 'acquired') {
                const lat = userLocation.lat.toFixed(4);
                const lon = userLocation.lon.toFixed(4);
                locationStatusSpan.textContent = `Location: ${lat}, ${lon} (Acquired)`;
                locationStatusSpan.classList.add(isDark ? 'bg-cyan-900' : 'bg-blue-200', isDark ? 'text-cyan-200' : 'text-blue-900');
            } else if (state === 'denied') {
                locationStatusSpan.textContent = `Location: Access Denied`;
                locationStatusSpan.classList.add('bg-red-700', 'text-white');
                // Show reminder modal
                permissionModal.classList.remove('hidden');
            } else { // 'off' or error
                locationStatusSpan.textContent = `Location: Off${message ? ` (${message})` : ''}`;
                locationStatusSpan.classList.add(isDark ? 'text-gray-400' : 'text-gray-700', isDark ? 'border-gray-700' : 'border-gray-300');
            }
        }


        window.getLocation = function() {
            if (navigator.geolocation) {
                updateLocationStatus('acquiring');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        updateLocationStatus('acquired');
                        console.log("Location acquired:", userLocation);
                    },
                    (error) => {
                        userLocation = null;
                        if (error.code === error.PERMISSION_DENIED) {
                            updateLocationStatus('denied');
                        } else {
                            updateLocationStatus('off', 'GPS Error');
                            console.error("Geolocation Error:", error.message);
                        }
                    },
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
                );
            } else {
                displayError("Geolocation is not supported by your browser.");
                updateLocationStatus('off', 'Unsupported');
            }
        }


        // --- Text-to-Speech (TTS) Implementation ---
        
        /**
         * Converts a base64 string to an ArrayBuffer.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Helper function to write a string into a DataView.
         */
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        /**
         * Converts 16-bit PCM data to a standard WAV Blob.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);
            let offset = 0;

            // RIFF chunk
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + pcm16.length * bytesPerSample, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;
            
            // fmt chunk
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2; // Audio format (1 for PCM)
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, sampleRate * numChannels * bytesPerSample, true); offset += 4; // Byte rate
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2; // Block align
            view.setUint16(offset, bytesPerSample * 8, true); offset += 2; // Bits per sample
            
            // data chunk
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, pcm16.length * bytesPerSample, true); offset += 4;

            // Write PCM data
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        /**
         * Calls the TTS model to convert text to speech and plays the audio.
         */
        async function speakText(text) {
            const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } 
                        }
                    }
                },
                model: TTS_MODEL
            };

            try {
                const response = await fetchWithRetry(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000; 

                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play().catch(e => console.error("Audio playback failed (browser restrictions?):", e));

                } else {
                    console.warn("TTS response missing audio data or incorrect mime type. This is likely expected in some API responses.");
                }
            } catch (error) {
                console.error("TTS API Error:", error);
            }
        }


        // --- Main Send Message Function ---

        window.sendMessage = async function() {
            const userQuery = userInput.value.trim();
            if (!userQuery && !uploadedImage) return;

            // --- UI State: User Message & Loading ---
            userInput.value = ''; 
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-70', 'cursor-not-allowed');
            loadingIndicator.classList.remove('hidden');
            systemStatusSpan.textContent = "Status: Thinking...";

            // 1. Prepend location data to the query if available
            let promptText = userQuery;
            if (userLocation) {
                // If the user didn't type anything but has an image/location, send the full prompt
                // If the user typed something, prepend location data to it
                promptText = `User Location: [${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}]. Query: ${userQuery}`;
            } else {
                promptText = userQuery || "Image attached.";
            }

            const currentImage = uploadedImage;
            
            // 2. Save the user's message to local memory/UI (before sending)
            // We display the original user input (without the Location prefix)
            await saveMessage('user', userQuery || "Image attached.", currentImage);
            
            // Clear location and image state immediately after using them
            userLocation = null;
            updateLocationStatus('off');
            clearImage();

            // 3. Prepare chat history for API (context)
            const contentsForApi = [...chatHistory]; 
            // The AI will see the full prompt (including location) as the last user message
            contentsForApi[contentsForApi.length - 1].parts[0].text = promptText;
            const limitedContentsForApi = contentsForApi.slice(-10); 

            const payload = {
                contents: limitedContentsForApi, 
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(API_URL, options);
                const result = await response.json();
                
                const modelResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!modelResponseText) {
                    throw new Error("Received an empty or malformed response from the model. This might be due to content policy blocks or an API error.");
                }
                
                const cleanResponseText = stripMarkdown(modelResponseText);

                // 4. Save the model response to local memory/UI
                await saveMessage('model', cleanResponseText);
                
                // 5. Speak the response using TTS
                await speakText(cleanResponseText);

            } catch (error) {
                console.error("API Error:", error);
                displayError(`API connection error: ${error.message}.`);
            } finally {
                loadingIndicator.classList.add('hidden');
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                userInput.focus();
                systemStatusSpan.textContent = "Status: Ready";
            }
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial theme based on the <html> attribute (which defaults to dark)
            const initialTheme = body.getAttribute('data-theme') || 'dark';
            updateThemeIcon(initialTheme);
            updateSystemStatusStyle(initialTheme);
            updateLocationStatus('off');
            
            // Re-wrap initial message for correct alignment
            const initialMessageContainer = document.createElement('div');
            initialMessageContainer.className = 'model-bubble-container';
            initialMessageContainer.appendChild(initialMessageBox);
            chatHistoryDiv.appendChild(initialMessageContainer);
        });
    </script>
</body>
</html>
