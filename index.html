<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI:az - The Respectful Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
       /* ========== GLOBAL VARIABLES ========== */
:root {
  --bg-light-start: #fef9e7;
  --bg-light-end: #fdf2e9;
  --bg-dark-start: #132a4e;
  --bg-dark-end: #0a1930;

  --text-light: #1a202c;
  --text-dark: #f3f4f6;

  --user-bg-light: #4caf50;
  --user-text-light: #ffffff;

  --model-bg-light: #ffe0b2;
  --model-text-light: #795548;

  --user-bg-dark: #81c784;
  --user-text-dark: #1a202c;

  --model-bg-dark: #3e2723;
  --model-text-dark: #ffcc80;
}

/* ========== BASE SETUP ========== */
html, body {
  padding: 0;
  margin: 0;
  height: 100dvh; /* mobile safe viewport */
  width: 100%;
  overflow: hidden;
  font-family: 'Inter', sans-serif;
  -webkit-tap-highlight-color: transparent;
}

/* Light Theme */
body {
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, var(--bg-light-start), var(--bg-light-end));
  color: var(--text-light);
}

/* Dark Theme */
.dark body {
  background: linear-gradient(135deg, var(--bg-dark-start), var(--bg-dark-end));
  color: var(--text-dark);
}

/* ========== APP CONTAINER ========== */
.app-container {
  display: flex;
  flex-direction: column;
  height: 100dvh;
  width: 100%;
  background: #ffffff;
  padding-bottom: env(safe-area-inset-bottom);
}

.dark .app-container {
  background: #1f2937;
}

/* ========== CHAT AREA ========== */
#chat-history {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  min-height: 0;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
}

/* ========== CHAT BUBBLES ========== */
.user-bubble, .model-bubble {
  max-width: 90%;
  padding: 0.9rem 1.15rem;
  margin: 0.45rem 0;
  border-radius: 1.4rem;
  word-break: break-word;
  white-space: pre-wrap;
  font-size: 0.97rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

/* Align */
.user-bubble-container {
  display: flex;
  justify-content: flex-end;
}

.model-bubble-container {
  display: flex;
  justify-content: flex-start;
}

/* Light Mode Bubbles */
.user-bubble {
  background: var(--user-bg-light);
  color: var(--user-text-light);
  border-radius: 1.4rem 1.4rem 0.4rem 1.4rem;
}

.model-bubble {
  background: var(--model-bg-light);
  color: var(--model-text-light);
  border-radius: 1.4rem 1.4rem 1.4rem 0.4rem;
}

/* Dark Mode Bubbles */
.dark .user-bubble {
  background: var(--user-bg-dark);
  color: var(--user-text-dark);
}

.dark .model-bubble {
  background: var(--model-bg-dark);
  color: var(--model-text-dark);
}

/* ========== IMAGE IN CHAT BUBBLE ========== */
.bubble-image {
  width: 100%;
  max-height: 12rem;
  object-fit: contain;
  border-radius: 0.6rem;
  margin-bottom: 0.4rem;
  background: #ffffff;
  padding: 4px;
}

/* ========== IMAGE PREVIEW GRID (BEFORE SEND) ========== */
.image-preview-wrapper {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(95px, 1fr));
  gap: 0.7rem;
  max-height: 150px;
  overflow-y: auto;
  margin-top: 0.5rem;
  -webkit-overflow-scrolling: touch;
}

.preview-item {
  position: relative;
  height: 90px;
  border-radius: 0.6rem;
  overflow: hidden;
  background: #e9ecef;
}

.preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.remove-image-btn-sm {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  font-size: 12px;
  font-weight: bold;
  background: rgba(255, 60, 60, 0.85);
  color: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ========== INPUT BAR ========== */
#user-input {
  width: 100%;
  border-radius: 50px;
  border: 2px solid #d1d5db;
  padding: 0.85rem 1.2rem;
  background: #f9fafb;
  font-size: 1rem;
}

.dark #user-input {
  background: #374151;
  border-color: #4b5563;
  color: #ffffff;
}

/* ========== AUDIO & ACTION BUTTONS ========== */
.audio-btn {
  background: none;
  border: none;
  padding: 0.35rem;
  cursor: pointer;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  transition: transform .18s;
}

.audio-btn:hover:not(:disabled) {
  transform: scale(1.12);
}

.audio-playing {
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.25); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}

/* ========== TYPING INDICATOR ========== */
.typing-indicator-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #ff9800;
  display: inline-block;
  margin: 0 2px;
  animation: bounce 1.3s infinite ease-in-out;
}

.dark .typing-indicator-dot {
  background: #ffb74d;
}

.typing-indicator-dot:nth-child(1) { animation-delay: -0.28s; }
.typing-indicator-dot:nth-child(2) { animation-delay: -0.14s; }

@keyframes bounce {
  0%,80%,100% { transform: scale(0); }
  40% { transform: scale(1); }
}

    </style>
</head>
<body class="p-0 m-0 transition-colors duration-300">
    

    <!-- Main App Container (Takes up the whole screen) -->
    <div class="app-container flex flex-col transition-colors duration-300 overflow-hidden">

        <!-- Header Section -->
        <!-- Add this inside your <nav> or top header section -->
<div class="logo">
    <img src=https://www.google.com/url?sa=i&url=https%3A%2F%2Fin.pinterest.com%2Fpin%2Fcircle-a-letter-logo-modern-a-logo--844143523939836583%2F&psig=AOvVaw0fy0AsufOwzZGFYhbkCut0&ust=1762611385707000&source=images&cd=vfe&opi=89978449&ved=0CBIQjRxqFwoTCJDLoZ6d4JADFQAAAAAdAAAAABAK" alt="AI:az Logo" style="height:48px;">
</div>

        <header class="p-3 flex justify-between items-center border-b shadow-md flex-shrink-0 bg-white dark:bg-gray-900 dark:border-gray-700 transition-colors duration-300 flex-wrap">

            <!-- Group 1: Toggle, New Chat, Title -->
@@ -300,7 +306,7 @@
            <!-- Typing Indicator (Replaced by just Loading) -->
            <div id="typing-indicator" class="hidden my-2 model-bubble-container">
                <div class="model-bubble text-sm text-gray-600 dark:text-gray-300 flex items-center p-3">
                    <span class="mr-3 font-semibold">AI:az likh raha hai...</span>
                    <span class="mr-3 font-semibold">AI:az is typing...</span>
                    <div class="flex">
                        <div class="typing-indicator-dot"></div>
                        <div class="typing-indicator-dot"></div>
                }
            } catch (error) {
                console.error("TTS API Error during speech generation:", error);
                displayError("TTS service mein koi gadbad ho gayi (Something went wrong in TTS service). Kripya network check karein, sir.");
                displayError("Something went wrong in TTS service ,Check Network.");
                stopAudioPlayback();
            }
        }

        // This function is called by the button click
        window.handleAudioPlayback = function(button) {
            // Get the full text from the parent bubble's data attribute
            const text = button.closest('.model-bubble').dataset.fullText;

            if (currentAudio && currentAudioButton === button) {
                // If the same audio is playing, stop it (correction/stop functionality)
                stopAudioPlayback();
            } else {
                // Otherwise, start or restart the audio
                speakText(text, button, true);
            }
        }

        // Function to be called after the model's text is fully displayed (INSTANTLY now)
        function startAutoAudio(button) {
            // Find the full text (it should be set in the saveMessage step)
            const text = button.closest('.model-bubble').dataset.fullText;
            if (text) {
                // Enable the button now that the text is complete
                button.disabled = false;
                systemStatusSpan.textContent = "Status: Ready (Audio playing)";
                // Ensure text is stripped of any final markdown for clean TTS input
                const cleanText = stripMarkdown(text);
                speakText(cleanText, button, true);
            }
        }

        // Helper function to add the audio button (used for initial message)
        function addAudioButtonToInitialMessage(text, wrapper) {
            const audioButton = document.createElement('button');
            audioButton.className = 'audio-btn w-6 h-6 flex-shrink-0';
            audioButton.title = 'Suniye (Listen)';
            audioButton.innerHTML = `<svg id="speaker-icon" class="w-full h-full" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M11 5L6 9H2v6h4l5 4V5zm7.5 7c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM16 5.86v12.28c2.19-.85 3.5-3.05 3.5-5.14s-1.31-4.29-3.5-5.14z"></path></svg>`;
            audioButton.onclick = () => handleAudioPlayback(audioButton);
            wrapper.appendChild(audioButton);
            wrapper.dataset.fullText = text;
        }

        // --- Main Send Message Function ---

        window.sendMessage = async function() {
            const userQuery = userInput.value.trim();
            if (!userQuery && uploadedImages.length === 0) return;

            // --- CRITICAL: Stop any currently playing audio immediately ---
            stopAudioPlayback();
            if (typingInterval) clearInterval(typingInterval); // Stop any ongoing typing


            // --- UI State: User Message & Loading ---
            userInput.value = ''; 
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-70', 'cursor-not-allowed');
            typingIndicator.classList.remove('hidden'); 
            systemStatusSpan.textContent = "Status: Soch raha hoon (Thinking), please wait...";

            let promptText = userQuery;
            const hasImages = uploadedImages.length > 0;

            if (userLocation) {
                // Location information ko Hindi mein shamil karein
                promptText = `User Location: [${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}]. Yeh location user ne di hai. Sawal: ${userQuery}`;
            } else if (hasImages && !userQuery) {
                 promptText = "Multiple images attach ki gayi hain. Kripya inmein kya dikh raha hai, bataiye aur mera margdarshan (guidance) karein?";
            } else if (hasImages && userQuery) {
                 promptText = `Sawalon par dhyan dete hue, in images ko analyze karein. Sawal: ${userQuery}`;
            }

            const currentImagesForSave = uploadedImages.map(img => ({
                data: img.data,
                mimeType: img.mimeType
            }));
            const currentImagesDataUrls = uploadedImages.map(img => img.dataUrl);

            // 1. Save and display the user's message immediately
            const userDisplayText = userQuery || (hasImages ? `Multiple Images Attached (${uploadedImages.length})` : "Image attached.");
            createMessageBubble('user', userDisplayText, currentImagesDataUrls);

            await saveMessage('user', userQuery, currentImagesForSave);

            // Clear location and image state immediately after using them
            userLocation = null;
            updateLocationStatus('off');
            clearImages();

            // 2. Prepare chat history for API (context)
            const contentsForApi = [...chatHistory]; 
            // The last entry contains the current prompt and images, we ensure the text part is correctly set
            const lastContent = contentsForApi[contentsForApi.length - 1];
            const textPart = lastContent.parts.find(p => p.text !== undefined);
            if (textPart) {
                textPart.text = promptText; 
            }

            const limitedContentsForApi = contentsForApi.slice(-10); 

            const payload = {
                contents: limitedContentsForApi, 
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            let modelResponseText = null;

            try {
                // Get the model's response text
                const response = await fetchWithRetry(API_URL, options);
                const result = await response.json();

                modelResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!modelResponseText) {
                    throw new Error("Model ne koi jawab nahi diya (Model returned an empty reply). Maafi chahta hoon, huzoor.");
                }

                const cleanResponseText = stripMarkdown(modelResponseText);

                // Hide indicator, update status
                typingIndicator.classList.add('hidden'); 
                systemStatusSpan.textContent = "Status: Jawab likh raha hoon (Writing reply)...";

                // Create the model bubble but with EMPTY text, so typing can start
                const {textSpan, audioButton} = createMessageBubble('model', '');

                // Set the full text on the bubble wrapper immediately for the TTS function later
                const modelBubble = textSpan.closest('.model-bubble');
                modelBubble.dataset.fullText = cleanResponseText; 

                // 3. Save the final message to history
                // This happens before typing starts, as the text is finalized now
                await saveMessage('model', cleanResponseText);

                // 4. *** Start the Typing Animation (and chain the audio) ***

                // Define callback to start audio after typing is done
                const audioCallback = () => {
                    systemStatusSpan.textContent = "Status: Awaaz shuru (Audio starting)...";
                    startAutoAudio(audioButton);
                };

                // Start typing the response with 35ms delay
                typeText(textSpan, cleanResponseText, 35, audioCallback);


            } catch (error) {
                // Log and display error
                console.error("API Error:", error);
                const errorMsg = error.message.includes("API connection error") ? error.message : `API request failed: ${error.message}`;
                displayError(errorMsg); 

                // If failed before typing, update status
                typingIndicator.classList.add('hidden');
                systemStatusSpan.textContent = "Status: Error";
            } finally {
                // Clean up UI state regardless of success or failure
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                userInput.focus();

                // If typing is still active (which shouldn't happen here if API failed immediately), we clear it.
                // Final status update will happen after audio starts in success case.
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            updateLocationStatus('off');

            // Re-wrap initial message for correct alignment
            const initialMessageContainer = document.createElement('div');
            initialMessageContainer.className = 'model-bubble-container';
            initialMessageContainer.appendChild(initialMessageBox);
            chatHistoryDiv.appendChild(initialMessageContainer);

            // Add audio button to initial message
            const initialText = document.getElementById('initial-message').textContent;
            const initialWrapper = initialMessageBox.querySelector('.model-bubble');

            addAudioButtonToInitialMessage(initialText, initialWrapper);

            // Ensure the initial message text span takes up necessary space
            document.getElementById('initial-message').classList.add('flex-grow');

            // Enable the initial message audio button
            const initialAudioButton = initialMessageBox.querySelector('.audio-btn');
            if (initialAudioButton) {
                initialAudioButton.disabled = false;
                // Immediately start audio for the initial message to comply with the "default" request
                startAutoAudio(initialAudioButton);
            }
        });
    </script>
</body>
</html>
